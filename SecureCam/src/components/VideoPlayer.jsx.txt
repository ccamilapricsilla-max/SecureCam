import React, { useState, useRef, useEffect } from 'react';
import { Upload, Video, X, AlertCircle, FileVideo, Trash2, RefreshCw } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { useToast } from '@/components/ui/use-toast';
import { cn } from '@/lib/utils';
import { useCameraContext } from '@/context/CameraContext';
import VideoUploadModal from './VideoUploadModal';

const VideoPlayer = ({ onVideoLoad, videoRef }) => {
  const [videoDuration, setVideoDuration] = useState(0);
  const [currentTime, setCurrentTime] = useState(0);
  const [showUploadModal, setShowUploadModal] = useState(false);
  
  const { selectedCameraId, videoStorage } = useCameraContext();
  const { toast } = useToast();

  const savedVideo = videoStorage.getVideoByCamera(selectedCameraId);

  // Load saved video when selection changes
  useEffect(() => {
    if (savedVideo && videoRef.current) {
      videoRef.current.src = savedVideo.base64Data;
      videoRef.current.load();
    } else if (videoRef.current) {
      videoRef.current.src = '';
      setVideoDuration(0);
      setCurrentTime(0);
    }
  }, [selectedCameraId, savedVideo, videoRef]);

  const handleDeleteVideo = () => {
    if (confirm('¿Estás seguro de que quieres eliminar este video?')) {
      if (videoStorage.deleteVideo(selectedCameraId)) {
        if (videoRef.current) {
          videoRef.current.src = '';
          videoRef.current.load();
        }
      }
    }
  };

  const handleLoadedMetadata = () => {
    if (videoRef.current) {
      setVideoDuration(videoRef.current.duration);
      if (onVideoLoad) {
        onVideoLoad();
      }
    }
  };

  const handleTimeUpdate = () => {
    if (videoRef.current) {
      setCurrentTime(videoRef.current.currentTime);
    }
  };

  const formatTime = (seconds) => {
    if (!seconds || isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  return (
    <div className="w-full bg-gray-900/50 backdrop-blur-sm rounded-lg overflow-hidden border border-gray-800 shadow-xl">
      <VideoUploadModal 
        isOpen={showUploadModal}
        onClose={() => setShowUploadModal(false)}
        cameraId={selectedCameraId}
      />

      {!savedVideo ? (
        /* Empty State */
        <div className="aspect-video flex flex-col items-center justify-center gap-4 p-8 bg-gradient-to-br from-gray-900 to-gray-800 border-2 border-dashed border-gray-700 rounded-lg m-1">
          <div className="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center">
            <Video className="w-10 h-10 text-gray-600" />
          </div>
          
          <div className="text-center max-w-md">
            <h3 className="text-xl font-semibold text-white mb-2">
              Sin señal de video
            </h3>
            <p className="text-gray-400 mb-6 text-sm">
              No hay video configurado para esta cámara. Sube un archivo para simular el feed en vivo.
            </p>
            
            <Button
              onClick={() => setShowUploadModal(true)}
              className="bg-purple-600 hover:bg-purple-700 text-white shadow-lg shadow-purple-900/20"
            >
              <Upload className="w-4 h-4 mr-2" />
              Cargar Video de Prueba
            </Button>
          </div>
        </div>
      ) : (
        /* Video Player Interface */
        <div className="relative group">
          <video
            ref={videoRef}
            className="w-full aspect-video bg-black"
            controls
            playsInline
            onLoadedMetadata={handleLoadedMetadata}
            onTimeUpdate={handleTimeUpdate}
            loop
          >
            Tu navegador no soporta la reproducción de video.
          </video>
          
          {/* Overlay Info */}
          <div className="absolute top-0 left-0 w-full p-4 bg-gradient-to-b from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
             <div className="flex justify-between items-start">
               <div className="flex items-center gap-2">
                 <div className="bg-red-600 px-2 py-0.5 rounded text-xs font-bold text-white uppercase tracking-wider animate-pulse">
                   REC
                 </div>
                 <span className="text-xs text-gray-300 font-mono">{new Date().toLocaleTimeString()}</span>
               </div>
             </div>
          </div>

          {/* Bottom Bar Info */}
          <div className="bg-gray-900 border-t border-gray-800 p-3 flex items-center justify-between flex-wrap gap-2">
            <div className="flex items-center gap-3 overflow-hidden">
              <div className="p-1.5 bg-purple-500/10 rounded-md">
                <FileVideo className="w-4 h-4 text-purple-400" />
              </div>
              <div className="flex flex-col min-w-0">
                <span className="text-sm font-medium text-gray-200 truncate max-w-[150px] md:max-w-xs">
                  {savedVideo.fileName}
                </span>
                <span className="text-xs text-gray-500 font-mono">
                  {formatTime(currentTime)} / {formatTime(videoDuration)}
                </span>
              </div>
            </div>
            
            <div className="flex items-center gap-2">
              <Button
                onClick={() => setShowUploadModal(true)}
                variant="ghost"
                size="sm"
                className="text-gray-400 hover:text-white hover:bg-gray-800"
              >
                <RefreshCw className="w-4 h-4 mr-2" />
                Cambiar
              </Button>
              <Button
                onClick={handleDeleteVideo}
                variant="ghost"
                size="sm"
                className="text-red-400 hover:text-red-300 hover:bg-red-900/20"
              >
                <Trash2 className="w-4 h-4 mr-2" />
                Borrar
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default VideoPlayer;