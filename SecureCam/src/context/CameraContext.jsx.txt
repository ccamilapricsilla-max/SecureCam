import React, { createContext, useContext, useState, useEffect } from 'react';
import { mockCameras } from '@/data/mockMotionData';
import useVideoStorage from '@/hooks/useVideoStorage';

const CameraContext = createContext();

export const CameraProvider = ({ children }) => {
  const [cameras, setCameras] = useState(mockCameras);
  const [selectedCameraId, setSelectedCameraId] = useState(1);
  
  const videoStorage = useVideoStorage();
  
  const [settings, setSettings] = useState({
    sensitivity: 75, // 0-100
    recordingInterval: '10min',
    notifications: true,
    resolution: '1080p'
  });

  const getSelectedCamera = () => {
    return cameras.find(c => c.id === Number(selectedCameraId)) || cameras[0];
  };

  const updateSettings = (newSettings) => {
    setSettings(prev => ({ ...prev, ...newSettings }));
  };

  // Sync video availability with camera objects for UI helpers
  useEffect(() => {
    setCameras(prevCameras => 
      prevCameras.map(cam => ({
        ...cam,
        hasStoredVideo: !!videoStorage.storedVideos[cam.id],
        storedVideoThumbnail: videoStorage.storedVideos[cam.id]?.thumbnail
      }))
    );
  }, [videoStorage.storedVideos]);

  return (
    <CameraContext.Provider value={{
      cameras,
      setCameras,
      selectedCameraId,
      setSelectedCameraId,
      getSelectedCamera,
      settings,
      updateSettings,
      videoStorage // Expose the entire storage interface
    }}>
      {children}
    </CameraContext.Provider>
  );
};

export const useCameraContext = () => {
  const context = useContext(CameraContext);
  if (!context) {
    throw new Error('useCameraContext must be used within a CameraProvider');
  }
  return context;
};