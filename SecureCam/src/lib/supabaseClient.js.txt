import { createClient } from '@supabase/supabase-js';

// IMPORTANT: Supabase integration is not yet configured
// To enable Supabase functionality:
// 1. Create a Supabase project at https://supabase.com
// 2. Copy .env.example to .env
// 3. Add your Supabase URL and anon key to .env
// 4. Restart the development server

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

let supabase = null;

if (supabaseUrl && supabaseAnonKey) {
  supabase = createClient(supabaseUrl, supabaseAnonKey);
}

// Helper function to check if Supabase is configured
export const isSupabaseConfigured = () => {
  return supabase !== null;
};

// Fallback to localStorage when Supabase is not configured
export const saveMotionDetection = async (detection) => {
  if (isSupabaseConfigured()) {
    const { data, error } = await supabase
      .from('motion_detections')
      .insert([detection])
      .select();
    
    if (error) throw error;
    return data[0];
  } else {
    // Fallback to localStorage
    const detections = JSON.parse(localStorage.getItem('motion_detections') || '[]');
    const newDetection = {
      id: crypto.randomUUID(),
      ...detection,
      timestamp: new Date().toISOString()
    };
    detections.push(newDetection);
    localStorage.setItem('motion_detections', JSON.stringify(detections));
    return newDetection;
  }
};

export const getMotionDetections = async () => {
  if (isSupabaseConfigured()) {
    const { data, error } = await supabase
      .from('motion_detections')
      .select('*')
      .order('timestamp', { ascending: false });
    
    if (error) throw error;
    return data;
  } else {
    // Fallback to localStorage
    const detections = JSON.parse(localStorage.getItem('motion_detections') || '[]');
    return detections.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  }
};

export const clearMotionDetections = async () => {
  if (isSupabaseConfigured()) {
    const { error } = await supabase
      .from('motion_detections')
      .delete()
      .neq('id', '00000000-0000-0000-0000-000000000000'); // Delete all
    
    if (error) throw error;
  } else {
    // Fallback to localStorage
    localStorage.setItem('motion_detections', JSON.stringify([]));
  }
};

export default supabase;